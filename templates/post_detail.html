{% extends 'basic.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock title %}

{% block extra_head %}
<link href="{% static 'assets/css/post_detail.css' %}" rel="stylesheet">
{% endblock extra_head %}

{% block body %}
<section class="post-detail-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10 col-12">
        <div class="post-detail-card">
          <h2>{{ post.title }}</h2>
          {% if post.media_type == 'image' and post.img %}
            <img src="{{ post.img.url }}" class="img-fluid" alt="{{ post.title }}">
          {% elif post.media_type == 'video' and post.video %}
            <video controls class="img-fluid">
                <source src="{{ post.video.url }}" type="video/mp4">
                Votre navigateur ne supporte pas la balise vidéo.
            </video>
          {% endif %}
          <p>{{ post.content|safe }}</p>
        </div>

        <div class="comments-section">
          <h3>Commentaires</h3>

          <div class="comment-form-card">
            <h4>Ajouter un commentaire</h4>
            <form method="POST" action="{% url 'add_comment' post.id %}">
                {% csrf_token %}
                {% for field in comment_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                            <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary">Ajouter un commentaire</button>
            </form>
          </div>

          <ul class="comment-list">
            {% for comment in comments %}
                <li class="comment-item">
                    <p><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>

                    <div class="reaction-section">
                        <h4>Réactions</h4>
                        <form method="POST" action="{% url 'add_reaction' comment.id %}">
                            {% csrf_token %}
                            {% for field in reaction_form %}
                                {{ field }}
                            {% endfor %}
                            <button type="submit" class="btn btn-sm">Réagir</button>
                        </form>
                    </div>

                    <div class="reply-section">
                        {% for reply in comment.replies.all %}
                            <div class="reply-item">
                                <p><strong>{{ reply.user.username }}</strong>: {{ reply.text }}</p>
                            </div>
                        {% endfor %}
                        <form method="POST" action="{% url 'add_reply' comment.id %}">
                            {% csrf_token %}
                            {% for field in reply_form %}
                                <div class="form-group">
                                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                    {{ field }}
                                </div>
                            {% endfor %}
                            <button type="submit" class="btn btn-sm btn-secondary">Répondre</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock body %}